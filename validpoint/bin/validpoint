#!/usr/bin/env node

/**
 * CW website validator access hub.
 * 
 * Invoking: 
 * ./bin/validpoint command (-d [domain1,[domain2,[domain3...]]])
 * See all commands and options:
 * ./bin/validpoint help
 */

require( "strict-mode" )(
    () =>
    {
		// Get an instance of the runner
		const CW_Runner = require( "../src/CW_Runner.js" );
		const runner = new CW_Runner();

		// And an instance of the parser
		const CW_InputParser =  require( "../src/CW_InputParser.js" );
		let config = null;

		const CW_Constants =  require( "../src/CW_Constants.js" );
		const colors = require( "../node_modules/colors" );
		colors.setTheme( CW_Constants.COLOR_THEME );

		let inputOptions = CW_Runner.processinputArguments()
			.then(
				( inputOptions ) =>
				{	
					let cmds = inputOptions.command;
					let domains = inputOptions.domain;
					let inputDirectory = null;

					let objectsToRun = 0;

					if( inputOptions.directory && inputOptions.directory.length > 0 )
					{
						inputDirectory = inputOptions.directory;
					}

					if( !domains || 
						(domains.length == 1 && domains[0] === undefined) )
					{
						// There were no input options and no config file input
						console.log();
						console.log( "You must specify a domain with '-d <domain>', supply an input configuration file, or have a validpoint.json file in the current directory." );
						console.log();

						let yargs = CW_Runner.getYargs();
						yargs.showHelp();
						process.exit();
					}

					// Foreach domain
					Object.keys( domains ).forEach(
						( domain ) =>
						{
							// Override commands from config/input

							// override commands for each domain
							if( inputOptions.domain[domain].preflight_commands && 
								inputOptions.domain[domain].preflight_commands.length > 0 )
							{
								cmds = inputOptions.domain[domain].preflight_commands;
							}

							if( inputOptions.domain[domain].commands && 
								inputOptions.domain[domain].commands.length > 0 )
							{
								// If there were no preflight commands, override any previously specified commands
								if( !inputOptions.domain[domain].preflight_commands || 
									inputOptions.domain[domain].preflight_commands.length < 1 )
								{
									cmds = inputOptions.domain[domain].commands;
								}
								else // or else add to the preflight commands
								{
									cmds = cmds.concat( inputOptions.domain[domain].commands );
								}
							}

							// Foreach command
							cmds.forEach(
								(command, index) =>
								{
									// 1. make runner object(s)
									CW_InputParser.makeRunnerObjects( { domain: domain, directory: inputDirectory } )
										.then(
											( runObjects ) =>
											{
												if( runObjects.length > 0 )
												{
													objectsToRun += runObjects.length;
												}
												
												runObjects.forEach(
													runObject =>
													{
														// 2. parse the input config file
														let parser = new CW_InputParser( runObject.file, runObject.directory );

														parser.init(
															function() // init callback
															{
																try
																{
																	config = this.parseJsonString();

																	if( config == null )
																	{
																		throw new Error( "COULD NOT READ INPUT CONFIGURATION FILE. EXITING." );
																	}
																	else if( config.error && config.error.length > 0 )
																	{
																		// config.error happens when a json file does not exist for the domain...
																		//   In the absence of a domain.json file, populate a config object with reasonable 
																		//   parameters for the given domain
																		config = 
																		{	...config,
																			name: domain,
																			domain: domain,
																			url: "www." + domain
																		}
																	}

																	config = 
																	{	...config,
																		show_raw: inputOptions.show_raw,
																		be_quiet: inputOptions.quiet
																	}

																	// override config options from input
																	if( inputOptions.domain[domain].name && inputOptions.domain[domain].name.length > 0 )
																	{
																		config.name = inputOptions.domain[domain].name;
																	}
																	if( inputOptions.domain[domain].url && inputOptions.domain[domain].url.length > 0 )
																	{
																		config.url = inputOptions.domain[domain].url;
																	}

																	// 3. Setup advice
																	let CW_Advice = require( "../src/CW_Advice.js" );
																	let advice = new CW_Advice();

																	// 4. runCommand
																	runner.runCommand( { command: command, configObject: config, adviceObject: advice } )
																		.then(
																			(response) =>
																			{
																				// 5. Display results
																				if( config.show_raw || config.be_quiet ) // will probably remove the be_quiet allowance here
																				{
																					console.log();
																					console.log( response );
																					console.log(); // Make a blank line for separation until we have nicer progressive output
																				}

																				if( (index + 1) == cmds.length )
																				{
																					if( objectsToRun < 1 )
																					{
																						console.log( "There were no commands to run. Try `validpoint --help`".warn );
																					}
																				}

																			}
																		);
																}
																catch( error ) // runCommand never receives rejections, so this will only be code or system errors - never test failures
																{
																	console.log( "There was a problem running your command. The error reported was:" );
																	console.log( error );
																	console.log( "Exiting now." );
																	process.exit( 1 );
																}
															}); // parser.init()
													});
											}
										);
								}); // cmds.forEach
						}); // domains.forEach
				});// processinputArguments then
	}
);
