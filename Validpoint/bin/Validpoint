#!/usr/bin/env node

/**
 * CW website validator access hub.
 * 
 * Invoking: ./bin/Validpoint -c [command] (-d [domain1,[domain2,[domain3...]]])
 * Invocation without "command" or "domain" is synonymous with "all" as the command or domain
 * 
 * TODO: handle unhandled Promise rejections
 * TODO: global constants throughout the code need to be consolidated before there are too many of them or too much code
 */

require( "strict-mode" )(
    () =>
    {
		// Get an instance of the runner
		const CW_Runner = require( "../../classes/CW_Runner.js" );
		const runner = new CW_Runner();

		// And an instance of the parser
		const CW_InputParser =  require( "../../classes/CW_InputParser.js" );
		let config = null;

		let inputOptions = CW_Runner.processinputArguments();
		let cmd = inputOptions.command;
		let domain = inputOptions.domain;

		CW_InputParser.makeRunnerObjects( domain ).then(
			( runObjects ) =>
			{
				if( runObjects && runObjects.length > 0 )
				{
					// The things that run in the forEach are synchronous, so checks for all domains run at once and return in no particular order
					runObjects.forEach(
						runObject =>
						{
							let parser = new CW_InputParser( runObject.file );

							parser.init(
								function() // init callback
								{
									try
									{
										// `this` is an instance of the InputParser
										config = this.parseJsonString();
					
										if( config == null )
										{
											throw new Error( "COULD NOT READ INPUT CONFIGURATION FILE. EXITING." );
										}

										let CW_Advice = require( "../../classes/CW_Advice.js" );
										let advice = new CW_Advice();
										runner.runCommand( { command: cmd, configObject: config, adviceObject: advice } );
									}
									catch( exception )
									{
										console.log( "Process exception:" );
										console.log( exception );
										process.exit( 1 );
									}
								}
							);
						}
					);
				}
				else // We didn't get any JSON files for input
				{
					throw new Error( "COULD NOT FIND ANY CONFIGURATION FILES TO RUN." );
				}
			}
		);
	}
);
