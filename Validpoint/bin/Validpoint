#!/usr/bin/env node

/**
 * CW website validator access hub.
 * 
 * Invoking: ./bin/Validpoint [command]
 * Invocation without "command" is synonymous with "all" as the command
 * 
 * TODO: handle unhandled Promise rejections
 */

require( "strict-mode" )(
    () =>
    {
		// Since the async file system calls return before completing, wrap parser functionality inside of an init completion/callback

		const CW_InputParser =  require( "../../classes/CW_InputParser.js" );
		let config = null;

		// TODO: We'll want a file iterator instead of hard-coding a single file name
		const parser = new CW_InputParser( "consultwebs.com.json" );

		parser.init(
			function() // init callback
			{
				try
				{
					const CW_Runner = require( "../../classes/CW_Runner.js" );
					const runner = new CW_Runner();

					// `this` is an instance of the InputParser
					config = this.parseJsonString();

					if( config == null )
					{
						throw new Error( "COULD NOT READ INPUT CONFIGURATION FILE. EXITING." );
						process.exit( 1 );
					}
					
					// parse the requested command from the command line arguments, then run it
					let cmd = "all";
					if( process.argv.length >= 3 )
					{
						cmd = process.argv[2];
					}

					runner.runCommand( cmd, config );
				}
				catch( exception )
				{
					console.log( `Process exception:\n${exception}` );
					process.exit( 1 );
				}
			}
		);
			

    }
);
